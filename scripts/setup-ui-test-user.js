/**
 * Setup persistent test user for Playwright UI mode
 *
 * This script creates a dedicated test user for interactive testing in Playwright UI.
 * Unlike the temporary users used in automated tests, this user persists across sessions.
 *
 * Usage:
 *   npm run test:ui:setup    (one-time setup)
 *   npm run test:ui          (then use Playwright UI)
 */

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');
const { TEST_ENV_PATH } = require('./test-env-config');
require('dotenv').config({ path: TEST_ENV_PATH });

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

// Persistent credentials for UI testing
const UI_TEST_EMAIL = 'playwright-ui-tester@outwardsign.test';
const UI_TEST_PASSWORD = 'TestPassword123!';
const UI_TEST_PARISH_NAME = 'Playwright UI Test Parish';

const envFilePath = path.join(__dirname, '..', '.env.test');

async function setupUITestUser() {
  console.log('ğŸ­ Setting up persistent test user for Playwright UI...\n');

  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
    auth: { autoRefreshToken: false, persistSession: false }
  });

  let userId = null;
  let parishId = null;

  try {
    // 1. Check if user already exists
    console.log('1ï¸âƒ£  Checking if UI test user exists...');
    const { data: existingUsers } = await supabase.auth.admin.listUsers();
    const existingUser = existingUsers?.users?.find(u => u.email === UI_TEST_EMAIL);

    if (existingUser) {
      userId = existingUser.id;
      console.log(`   âœ… User already exists with ID: ${userId}`);

      // Get parish ID from user_settings
      const { data: settings } = await supabase
        .from('user_settings')
        .select('selected_parish_id')
        .eq('user_id', userId)
        .single();

      if (settings?.selected_parish_id) {
        parishId = settings.selected_parish_id;
        console.log(`   âœ… Parish already exists with ID: ${parishId}`);
      }
    } else {
      // Create new user
      const { data: newUser, error: createError } = await supabase.auth.admin.createUser({
        email: UI_TEST_EMAIL,
        password: UI_TEST_PASSWORD,
        email_confirm: true,
        user_metadata: {
          full_name: 'Playwright UI Tester'
        }
      });

      if (createError) {
        throw new Error(`Failed to create user: ${createError.message}`);
      }

      userId = newUser.user.id;
      console.log(`   âœ… User created with ID: ${userId}`);
    }

    // 2. Check if parish exists
    if (!parishId) {
      console.log('\n2ï¸âƒ£  Creating test parish...');
      const { data: newParish, error: parishError } = await supabase
        .from('parishes')
        .insert({
          name: UI_TEST_PARISH_NAME,
          city: 'Test City',
          state: 'TS'
        })
        .select()
        .single();

      if (parishError) {
        throw new Error(`Failed to create parish: ${parishError.message}`);
      }

      parishId = newParish.id;
      console.log(`   âœ… Parish created with ID: ${parishId}`);

      // 3. Link user to parish
      console.log('\n3ï¸âƒ£  Linking user to parish...');
      const { error: linkError } = await supabase
        .from('parish_users')
        .upsert({
          parish_id: parishId,
          user_id: userId,
          roles: ['staff']
        }, {
          onConflict: 'user_id,parish_id'
        });

      if (linkError) {
        throw new Error(`Failed to link user to parish: ${linkError.message}`);
      }

      console.log('   âœ… User linked to parish with staff role');

      // 4. Set up user settings
      console.log('\n4ï¸âƒ£  Setting up user settings...');
      const { error: settingsError } = await supabase
        .from('user_settings')
        .upsert({
          user_id: userId,
          selected_parish_id: parishId
        }, {
          onConflict: 'user_id'
        });

      if (settingsError) {
        throw new Error(`Failed to update user settings: ${settingsError.message}`);
      }

      console.log('   âœ… User settings configured');
    }

    // 5. Save credentials to .env.test
    console.log('\n5ï¸âƒ£  Saving credentials to .env.test...');
    const envContent = `# Persistent test user credentials for Playwright UI mode
# Generated by scripts/setup-ui-test-user.js
TEST_USER_EMAIL=${UI_TEST_EMAIL}
TEST_USER_PASSWORD=${UI_TEST_PASSWORD}
TEST_PARISH_NAME=${UI_TEST_PARISH_NAME}
TEST_PARISH_CITY=Test City
TEST_PARISH_STATE=TS
`;

    fs.writeFileSync(envFilePath, envContent);
    console.log('   âœ… Credentials saved to .env.test');

    console.log('\nâœ¨ UI test user setup complete!\n');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`ğŸ“§ Email: ${UI_TEST_EMAIL}`);
    console.log(`ğŸ”‘ Password: ${UI_TEST_PASSWORD}`);
    console.log(`ğŸ›ï¸  Parish: ${UI_TEST_PARISH_NAME}`);
    console.log(`ğŸ‘¤ User ID: ${userId}`);
    console.log(`ğŸ†” Parish ID: ${parishId}`);
    console.log(`ğŸ‘” Role: staff`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    console.log('âœ… You can now run Playwright UI:');
    console.log('   npm run test:ui\n');

  } catch (error) {
    console.error('\nâŒ Error:', error.message);
    process.exit(1);
  }
}

setupUITestUser();
