# Pronunciation Fields - Changelog

**Date:** November 23, 2025
**Feature:** Person Pronunciation Fields
**Impact:** Database schema, Person module, All sacrament modules (Wedding, Funeral, Baptism, Quinceanera, Presentation)

---

## Overview

Added pronunciation fields to the `people` table to help presiders and liturgical ministers correctly pronounce names during ceremonies. This feature automatically displays pronunciation guidance throughout all liturgical scripts and person records.

---

## Changes Made

### 1. Database Schema

**Migration:** `supabase/migrations/20251031000001_create_people_table.sql`

Added four new fields to the `people` table:

```sql
-- Individual pronunciation fields (optional)
first_name_pronunciation TEXT,
last_name_pronunciation TEXT,

-- Auto-generated full name pronunciation (computed column)
full_name_pronunciation TEXT GENERATED ALWAYS AS (
  COALESCE(first_name_pronunciation, first_name) || ' ' || COALESCE(last_name_pronunciation, last_name)
) STORED,
```

**Key Features:**
- `first_name_pronunciation` and `last_name_pronunciation` are optional TEXT fields
- `full_name_pronunciation` is auto-generated by the database
- Falls back to actual name if pronunciation not provided
- STORED as a computed column for query efficiency

### 2. TypeScript Types

**File:** `src/lib/types.ts`

Updated `Person` interface:

```typescript
export interface Person {
  id: string
  parish_id: string
  first_name: string
  first_name_pronunciation?: string  // NEW
  last_name: string
  last_name_pronunciation?: string   // NEW
  full_name: string
  full_name_pronunciation: string    // NEW
  // ... other fields
}
```

### 3. Server Actions

**File:** `src/lib/actions/people.ts`

Updated `CreatePersonData` and `UpdatePersonData` interfaces:

```typescript
export interface CreatePersonData {
  first_name: string
  first_name_pronunciation?: string  // NEW
  last_name: string
  last_name_pronunciation?: string   // NEW
  // ... other fields
}

export interface UpdatePersonData {
  first_name?: string
  first_name_pronunciation?: string  // NEW
  last_name?: string
  last_name_pronunciation?: string   // NEW
  // ... other fields
}
```

Updated `createPerson()` and `updatePerson()` functions to handle the new fields.

### 4. Person Form

**File:** `src/app/(main)/people/person-form.tsx`

Added pronunciation fields to the form:

```tsx
<FormField
  id="first_name_pronunciation"
  label="First Name Pronunciation (Optional)"
  value={firstNamePronunciation}
  onChange={setFirstNamePronunciation}
  placeholder="How to pronounce first name"
/>

<FormField
  id="last_name_pronunciation"
  label="Last Name Pronunciation (Optional)"
  value={lastNamePronunciation}
  onChange={setLastNamePronunciation}
  placeholder="How to pronounce last name"
/>
```

**Location:** Placed directly below the First Name and Last Name fields in a 2-column grid layout.

### 5. Person View

**File:** `src/app/(main)/people/[id]/person-view-client.tsx`

Updated details section to display pronunciation when available:

```tsx
{(person.first_name_pronunciation || person.last_name_pronunciation) && (
  <div>
    <span className="font-medium">Pronunciation:</span>
    <div className="text-sm text-muted-foreground mt-1">
      {person.first_name_pronunciation && person.last_name_pronunciation
        ? `${person.first_name_pronunciation} ${person.last_name_pronunciation}`
        : person.first_name_pronunciation
        ? `${person.first_name_pronunciation} (first name)`
        : `${person.last_name_pronunciation} (last name)`
      }
    </div>
  </div>
)}
```

### 6. Formatter Functions

**File:** `src/lib/utils/formatters.ts`

Created two new pronunciation-aware formatter functions and kept original `formatPersonWithPhone()` unchanged:

**New Function 1: formatPersonWithPronunciation()**

Used for liturgy document titles and ceremony scripts (without phone numbers):

```typescript
export function formatPersonWithPronunciation(
  person?: {
    full_name: string
    full_name_pronunciation?: string | null
  } | null
): string {
  if (!person) return ''
  let result = person.full_name
  if (person.full_name_pronunciation && person.full_name_pronunciation !== person.full_name) {
    result += ` (${person.full_name_pronunciation})`
  }
  return result
}
```

**Impact:** Used for primary participants in ceremony scripts and title functions:
- ✅ Wedding: bride and groom (title functions)
- ✅ Funeral: deceased (title functions - `buildTitleEnglish()`, `buildTitleSpanish()`)
- ✅ Baptism: child (ceremony scripts)
- ✅ Quinceañera: quinceañera (title functions - `buildTitleEnglish()`, `buildTitleSpanish()`)
- ✅ Presentation: child (ceremony scripts)

**New Function 2: formatPersonWithPronunciationWithPhone()**

Used for cover page displays (with phone numbers):

```typescript
export function formatPersonWithPronunciationWithPhone(
  person?: {
    full_name: string
    full_name_pronunciation?: string | null
    phone_number?: string | null
  } | null
): string {
  if (!person) return ''

  let result = person.full_name

  // Add pronunciation if different from full_name
  if (person.full_name_pronunciation && person.full_name_pronunciation !== person.full_name) {
    result += ` (${person.full_name_pronunciation})`
  }

  // Add phone if available
  if (person.phone_number) {
    result += ` — ${person.phone_number}`
  }

  return result
}
```

**Impact:** Used ONLY for primary ceremony participants on cover pages:
- ✅ Wedding: bride and groom (English & Spanish templates)
- ✅ Funeral: deceased (English & Spanish templates)
- ✅ Baptism: child (English & Spanish templates)
- ✅ Quinceañera: quinceañera (English & Spanish templates)
- ✅ Presentation: child (English, Spanish, Bilingual, Simple-English, Simple-Spanish templates)

**Original Function (unchanged):**

```typescript
export function formatPersonWithPhone(
  person?: { full_name: string; phone_number?: string | null } | null
): string {
  if (!person) return ''
  return person.phone_number ? `${person.full_name} — ${person.phone_number}` : person.full_name
}
```

All other roles (presiders, coordinators, readers, musicians, family contacts, witnesses, sponsors, parents) continue using the original `formatPersonWithPhone()` function without pronunciation.

**Format Examples:**
- Full details: `"John Smith (jawn smith) — 555-1234"`
- Pronunciation only: `"John Smith (jawn smith)"`
- Phone only: `"John Smith — 555-1234"`
- Name only: `"John Smith"`

### 7. Helper Files

**Updated helper files to use `formatPersonWithPronunciation()` in title functions:**

**File:** `src/lib/content-builders/funeral/helpers.ts`
- **Changes:** Updated `buildTitleEnglish()` and `buildTitleSpanish()` functions
- **Lines:** 23, 33
- **Before:** `funeral.deceased.full_name`
- **After:** `formatPersonWithPronunciation(funeral.deceased)`

**File:** `src/lib/content-builders/quinceanera/helpers.ts`
- **Changes:** Updated `buildTitleEnglish()` and `buildTitleSpanish()` functions
- **Lines:** 35, 45
- **Before:** `quinceanera.quinceanera.full_name`
- **After:** `formatPersonWithPronunciation(quinceanera.quinceanera)`

**Note:** Wedding and Presentation modules already use `first_name` and `last_name` separately in their helper functions, not `full_name`, so no changes were needed. Baptism module has an empty helpers file with no title functions yet.

### 8. Documentation

**Files Updated:**
- `docs/FORMATTERS.md` - Added documentation for `formatPersonWithPronunciation()` function
- `docs/FORMATTERS.md` - Updated documentation for `formatPersonWithPronunciationWithPhone()` function
- `docs/FORMATTERS.md` - Updated Person Formatting section with pronunciation field details
- `docs/CHANGELOG_PRONUNCIATION_FIELDS.md` - Updated this changelog with helper file changes and new formatter function

---

## Migration Instructions

To apply these changes to your database:

```bash
npm run db:fresh
```

This will:
1. Reset the local database
2. Apply all migrations including the pronunciation fields
3. Re-seed test data

**Note:** After migration, existing person records will have `NULL` values for pronunciation fields, and `full_name_pronunciation` will equal `full_name` (fallback behavior).

---

## Usage Examples

### Creating a Person with Pronunciation

```typescript
import { createPerson } from '@/lib/actions/people'

const person = await createPerson({
  first_name: 'Siobhan',
  first_name_pronunciation: 'shi-VAWN',
  last_name: 'O\'Sullivan',
  last_name_pronunciation: 'oh-SUL-ih-van',
  phone_number: '555-1234',
  email: 'siobhan@example.com'
})

// Database generates:
// full_name = "Siobhan O'Sullivan"
// full_name_pronunciation = "shi-VAWN oh-SUL-ih-van"
```

### Updating Pronunciation Only

```typescript
import { updatePerson } from '@/lib/actions/people'

await updatePerson(person.id, {
  first_name_pronunciation: 'shi-VAWN'
})
```

### Display in Liturgical Script

When building a wedding liturgy:

```typescript
const weddingRows = []
if (wedding.bride) {
  weddingRows.push({
    label: 'Bride:',
    value: formatPersonWithPhone(wedding.bride)
    // Shows: "Siobhan O'Sullivan (shi-VAWN oh-SUL-ih-van) — 555-1234"
  })
}
```

---

## Benefits

1. **Helps Presiders:** Clergy and liturgical ministers can correctly pronounce names during ceremonies
2. **Respectful Celebration:** Ensures names are pronounced correctly, showing respect to participants
3. **No Code Duplication:** Single formatter update applies across all modules
4. **Automatic Fallback:** If pronunciation not provided, displays normal name without error
5. **Smart Display:** Only shows pronunciation if it differs from the actual name
6. **Database-Computed:** `full_name_pronunciation` is always in sync with individual fields

---

## Technical Notes

### Why COALESCE in Generated Column?

```sql
COALESCE(first_name_pronunciation, first_name) || ' ' || COALESCE(last_name_pronunciation, last_name)
```

This ensures:
- If `first_name_pronunciation` is NULL, use `first_name` instead
- If `last_name_pronunciation` is NULL, use `last_name` instead
- Result is never NULL (always returns a valid string)
- Consistent behavior across all queries

### Why Check if Pronunciation Differs?

```typescript
if (person.full_name_pronunciation && person.full_name_pronunciation !== person.full_name)
```

This prevents redundant display:
- If name is "John Smith" and pronunciation is "John Smith", don't show "(John Smith)"
- Only show pronunciation when it provides additional value
- Cleaner output for names that don't need pronunciation help

---

## Testing

After implementing, verify:

1. ✅ Can create person with pronunciation fields in form
2. ✅ Can update person pronunciation in edit form
3. ✅ Person view displays pronunciation when available
4. ✅ Wedding script shows bride/groom pronunciation on cover page
5. ✅ Funeral script shows deceased pronunciation on cover page
6. ✅ Baptism script shows child pronunciation on cover page
7. ✅ Quinceanera script shows quinceanera pronunciation on cover page
8. ✅ Presentation script shows child pronunciation on cover page
9. ✅ PDF exports include pronunciation in all modules
10. ✅ Word exports include pronunciation in all modules
11. ✅ Pronunciation not shown when it equals actual name
12. ✅ Database migration applies without errors

---

## Future Enhancements

Potential future improvements:

1. **IPA Support:** International Phonetic Alphabet notation
2. **Audio Pronunciation:** Record and play audio clips
3. **Automatic Suggestions:** AI-based pronunciation hints for common names
4. **Language-Specific:** Different pronunciation systems for different languages
5. **Honorifics:** Pronunciation for titles (Fr., Deacon, etc.)
